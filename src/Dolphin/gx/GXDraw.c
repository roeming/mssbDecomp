#include "Dolphin/gx.h"
#include "Dolphin/mtx.h"
#include "math.h"

static void normalize(f32 v[3])
{
    f32 d = dolsqrtf((v[0] * v[0]) + (v[1] * v[1]) + (v[2] * v[2]));

    v[0] /= d;
    v[1] /= d;
    v[2] /= d;
}

static void myvertex(f32 v[3], f32 n[3])
{
    GXPosition3f32(v[0], v[1], v[2]);
    GXNormal3f32(n[0], n[1], n[2]);
}

static void DumpTriangle(f32 v0[3], f32 v1[3], f32 v2[3])
{
    GXBegin(GX_TRIANGLES, GX_VTXFMT3, 3);
    myvertex(v0, v0);
    myvertex(v1, v1);
    myvertex(v2, v2);
    GXEnd();
}

static void Subdivide(u8 depth, f32 v0[3], f32 v1[3], f32 v2[3])
{
    f32 v01[3];
    f32 v12[3];
    f32 v20[3];
    u32 i;

    if (depth == 0) {
        DumpTriangle(v0, v1, v2);
        return;
    }

    for (i = 0; i < 3; i++) {
        v01[i] = v0[i] + v1[i];
        v12[i] = v1[i] + v2[i];
        v20[i] = v2[i] + v0[i];
    }
    normalize(v01);
    normalize(v12);
    normalize(v20);
    Subdivide(depth - 1, v0, v01, v20);
    Subdivide(depth - 1, v1, v12, v01);
    Subdivide(depth - 1, v2, v20, v12);
    Subdivide(depth - 1, v01, v12, v20);
}

// unsure what these are for, but they're padding out .data?
static u8 unusedBytes[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0b, 
    0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x08, 
    0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x0e,
    0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x03, 
    0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0f, 
    0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 
    0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x11, 
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x07, 
    0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x12, 
    0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x07, 
    0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x04, 
    0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x0c, 
    0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x0b, 
    0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x10, 
    0xbf, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x9e, 0x37, 0x37, 0xbf, 0x4f, 0x1b, 0x9b, 
    0x00, 0x00, 0x00, 0x00, 0xbe, 0x9e, 0x37, 0x37, 0x3f, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 
    0xbe, 0x9e, 0x37, 0x37, 0x3f, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x9e, 0x37, 0x37, 
    0x3e, 0x9e, 0x37, 0x37, 0xbf, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 0xbe, 0x9e, 0x37, 0x37, 
    0xbf, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 0xbe, 0x9e, 0x37, 0x37, 0x3f, 0x4f, 0x1b, 0x9b, 
    0x00, 0x00, 0x00, 0x00, 0x3e, 0x9e, 0x37, 0x37, 0x3f, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x3e, 0x9e, 0x37, 0x37, 0xbf, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 
    0xbe, 0x9e, 0x37, 0x37, 0xbf, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 0xbe, 0x9e, 0x37, 0x37, 
    0x3f, 0x4f, 0x1b, 0x9b, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x9e, 0x37, 0x37, 0x3f, 0x4f, 0x1b, 0x9b, 
    0xbf, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 
    0xbf, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 
    0xbf, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
    0xbf, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 
    0x3f, 0x00, 0x00, 0x00, 0xbf, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
    0xbf, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
    0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbf, 0x80, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbf, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xbf, 0x80, 0x00, 0x00, 0x00, 0x04, 0x02, 0x01, 0x02, 0x04, 0x00, 0x03, 
    0x04, 0x01, 0x04, 0x03, 0x00, 0x02, 0x05, 0x01, 0x05, 0x02, 0x00, 0x05, 0x03, 0x01, 0x03, 0x05
};

static GXVtxDescList lbl_802E6910[27];
static GXVtxAttrFmtList lbl_802E69E8[27];

static Vec SpherePoints[] = {
    { -0.5257311f,  0.f,  0.8506508f },
    {  0.5257311f,  0.f,  0.8506508f },
    { -0.5257311f,  0.f, -0.8506508f },
    {  0.5257311f,  0.f, -0.8506508f },
    {  0.f,  0.8506508f,  0.5257311f },
    {  0.f,  0.8506508f, -0.5257311f },
    {  0.f, -0.8506508f,  0.5257311f },
    {  0.f, -0.8506508f, -0.5257311f },
    {  0.8506508f,  0.5257311f,  0.f },
    { -0.8506508f,  0.5257311f,  0.f },
    {  0.8506508f, -0.5257311f,  0.f },
    { -0.8506508f, -0.5257311f,  0.f },
};

static u8 SphereIndices[20][3] = {
    { 0x00, 0x04, 0x01 },
    { 0x00, 0x09, 0x04 },
    { 0x09, 0x05, 0x04 },
    { 0x04, 0x05, 0x08 },
    { 0x04, 0x08, 0x01 },
    { 0x08, 0x0a, 0x01 },
    { 0x08, 0x03, 0x0a },
    { 0x05, 0x03, 0x08 },
    { 0x05, 0x02, 0x03 },
    { 0x02, 0x07, 0x03 },
    { 0x07, 0x0a, 0x03 },
    { 0x07, 0x06, 0x0a },
    { 0x07, 0x0b, 0x06 },
    { 0x0b, 0x00, 0x06 },
    { 0x00, 0x01, 0x06 },
    { 0x06, 0x01, 0x0a },
    { 0x09, 0x00, 0x0b },
    { 0x09, 0x0b, 0x02 },
    { 0x09, 0x02, 0x05 },
    { 0x07, 0x02, 0x0b }
};

void GXDrawSphere1(u8 subdivisions)
{
    s32 i;
    GXGetVtxDescv(lbl_802E6910);
    GXGetVtxAttrFmtv(GX_VTXFMT3, lbl_802E69E8);
    GXClearVtxDesc();
    GXSetVtxDesc(GX_VA_POS, GX_DIRECT);
    GXSetVtxDesc(GX_VA_NRM, GX_DIRECT);
    GXSetVtxAttrFmt(GX_VTXFMT3, GX_VA_POS, GX_CLR_RGBA, GX_F32, 0);
    GXSetVtxAttrFmt(GX_VTXFMT3, GX_VA_NRM, GX_CLR_RGB, GX_F32, 0);
    i = 19;
    do {
        u8 ii = i;
        Subdivide(subdivisions, (f32*)&SpherePoints[SphereIndices[ii][0]], (f32*)&SpherePoints[SphereIndices[ii][1]], (f32*)&SpherePoints[SphereIndices[ii][2]]);
        i--;
    } while(i >= 0);
    GXSetVtxDescv(lbl_802E6910);
    GXSetVtxAttrFmtv(GX_VTXFMT3, lbl_802E69E8);
}